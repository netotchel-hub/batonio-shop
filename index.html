<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresh Food Market</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        .app {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* –®–∞–ø–∫–∞ —Å —Ñ–æ–Ω–∞–º–∏ */
        .header {
            padding: 28px 20px;
            background-size: cover;
            background-position: center;
            color: white;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background-color: #1a1a2e;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.4));
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: white;
        }

        .welcome-text {
            font-size: 17px;
            opacity: 0.95;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
            line-height: 1.4;
            color: white;
        }

        /* –ì–æ—Ä–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ */
        .cities-bar {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            background: white;
        }

        .cities-container {
            display: flex;
            gap: 10px;
        }

        .city-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: 1.5px solid #e0e0e0;
            background: white;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #444;
        }

        .city-btn.active {
            background: #1a1a2e;
            color: white;
            border-color: #1a1a2e;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .categories-nav {
            display: flex;
            padding: 16px 20px;
            gap: 12px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }

        .category-tab {
            flex: 1;
            padding: 14px 8px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            background: #f5f7fa;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-tab.active {
            background: #1a1a2e;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* –¢–æ–≤–∞—Ä—ã - 2 –≤ —Ä—è–¥ */
        .products-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 20px;
            flex: 1;
            padding-bottom: 480px;
        }

        .product-card {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(0,0,0,0.02);
            border: 1px solid #f5f5f5;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-bottom: 1px solid #fafafa;
        }

        .product-info {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1a1a2e;
        }

        .product-weight {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }

        .product-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 16px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .product-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .product-price {
            font-size: 20px;
            font-weight: 800;
            color: #1a1a2e;
        }

        .add-btn {
            background: #e94560;
            color: white;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 6px 14px rgba(233, 69, 96, 0.25);
            font-weight: 500;
        }

        .add-btn:active {
            transform: scale(0.85);
        }

        /* –§–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ */
        .customer-form {
            background: white;
            border-top: 1px solid #f0f0f0;
            padding: 20px;
        }

        .form-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e0e0e0;
            border-radius: 14px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus {
            border-color: #1a1a2e;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26,26,46,0.05);
        }

        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e0e0e0;
            border-radius: 14px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
            min-height: 80px;
            resize: vertical;
        }

        .save-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 16px 0;
            font-size: 15px;
            color: #2c3e50;
        }

        .save-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #1a1a2e;
        }

        /* –ö–æ—Ä–∑–∏–Ω–∞ –≤–Ω–∏–∑—É */
        .cart-fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-top: 1px solid #f0f0f0;
            box-shadow: 0 -8px 25px rgba(0,0,0,0.08);
            padding: 20px;
            z-index: 1000;
            border-radius: 24px 24px 0 0;
        }

        .cart-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 4px;
        }

        .cart-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cart-icon {
            font-size: 24px;
            color: #1a1a2e;
        }

        .cart-text {
            font-size: 17px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .cart-total {
            font-size: 20px;
            font-weight: 800;
            color: #1a1a2e;
        }

        /* –ß–µ–∫–±–æ–∫—Å—ã —É—Å–ª–æ–≤–∏–π */
        .checkboxes {
            margin-bottom: 16px;
            padding: 0 4px;
            border-top: 1px solid #f0f0f0;
            padding-top: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 15px;
            color: #2c3e50;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #1a1a2e;
            border-radius: 6px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã */
        .payment-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 18px;
            background: #00a86b;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 8px 20px rgba(0,168,107,0.2);
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .payment-btn:active {
            transform: scale(0.97);
        }

        .payment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫–∞–∑–∞ - –í–°–ï–ì–î–ê –ß–ï–†–ù–ê–Ø */
        .order-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 18px;
            background: #1a1a2e !important;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 8px 20px rgba(26,26,46,0.2);
            letter-spacing: 0.5px;
        }

        .order-btn:active {
            transform: scale(0.97);
        }

        .order-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            grid-column: 1/-1;
            text-align: center;
            padding: 50px 20px;
            color: #888;
            font-size: 17px;
        }

        @media (max-width: 480px) {
            .products-grid {
                gap: 12px;
                padding: 16px;
                padding-bottom: 520px;
            }
            
            .product-image {
                height: 140px;
            }
            
            .cart-fixed-bottom {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- –®–∞–ø–∫–∞ —Å —Ñ–æ–Ω–∞–º–∏ -->
        <div class="header" id="header">
            <div class="header-content">
                <div class="welcome-title" id="welcomeTitle">Fresh Food Market</div>
                <div class="welcome-text" id="welcomeText">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é...</div>
            </div>
        </div>

        <!-- –ì–æ—Ä–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
        <div class="cities-bar">
            <div class="cities-container" id="citiesContainer"></div>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="categories-nav" id="categoriesNav"></div>

        <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div id="productsContainer" class="products-grid"></div>

        <!-- –§–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div class="customer-form">
            <div class="form-title">
                üìã –ü–æ–ª—É—á–∞—Ç–µ–ª—å
            </div>
            
            <div class="form-group">
                <label class="form-label">–í–∞—à–µ –∏–º—è *</label>
                <input type="text" class="form-input" id="customerName" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" autocomplete="name">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                <input type="tel" class="form-input" id="customerPhone" placeholder="+7 (999) 123-45-67" autocomplete="tel">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                <textarea class="form-textarea" id="customerAddress" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞, –ø–æ–¥—ä–µ–∑–¥, —ç—Ç–∞–∂"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                <textarea class="form-textarea" id="customerComment" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ, –∑–≤–æ–Ω–æ–∫ –≤ –¥–æ–º–æ—Ñ–æ–Ω –∏ —Ç.–¥."></textarea>
            </div>
            
            <label class="save-checkbox">
                <input type="checkbox" id="saveCustomerData" checked>
                <span>üíæ –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤</span>
            </label>
        </div>

        <!-- –ö–æ—Ä–∑–∏–Ω–∞ –≤–Ω–∏–∑—É -->
        <div class="cart-fixed-bottom" id="cartFixedBottom">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–∑–∏–Ω–µ -->
            <div class="cart-info">
                <div class="cart-left">
                    <span class="cart-icon">üõí</span>
                    <span class="cart-text" id="cartCountText">–ö–æ—Ä–∑–∏–Ω–∞ ¬∑ 0 —Ç–æ–≤–∞—Ä–æ–≤</span>
                </div>
                <div class="cart-total" id="cartTotalFixed">0 ‚ÇΩ</div>
            </div>
            
            <!-- –ß–µ–∫–±–æ–∫—Å—ã —É—Å–ª–æ–≤–∏–π -->
            <div class="checkboxes" id="checkboxesContainer"></div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã -->
            <button class="payment-btn" id="paymentBtn">
                üí≥ –ò–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã
            </button>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫–∞–∑–∞ - –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã -->
            <button class="order-btn" id="orderBtn" style="display: none;">
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
        </div>
    </div>

    <script>
        // ======================================
        // ‚úÖ –¢–í–û–ò –î–ê–ù–ù–´–ï - –í–°–Å –ü–û–î–°–¢–ê–í–õ–ï–ù–û
        // ======================================
        
        // ‚ö†Ô∏è –í–°–¢–ê–í–¨ –°–°–´–õ–ö–£ –ù–ê APPS SCRIPT –ü–û–°–õ–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyUEiyjkVKu_CotMkoZlDM0PfIVbDnhjcx4rf84MPPYkzFOR73Ul-AtmUcjHq830l3l/exec';
        
        // –¢–≤–æ—è —Ç–∞–±–ª–∏—Ü–∞
        const SHEET_ID = '1zJuZMK0kJc_tXfytZZD08S_l3STHvJ2U-ojM0V5jz4Q';
        
        // GID –ª–∏—Å—Ç–æ–≤
        const GIDS = {
            categories: 0,
            products: 430596501,
            cities: 634714368,
            checkboxes: 523008819,
            appConfig: 1196520463
        };

        // CORS proxy
        const PROXY = 'https://corsproxy.io/?';

        // Telegram
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.ready();
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let appState = {
            categories: [],
            products: [],
            cities: [],
            checkboxes: [],
            config: {},
            activeCategory: 1,
            activeCity: '',
            cart: [],
            isPaid: false
        };

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó GOOGLE SHEETS ==========
        async function fetchSheet(gid) {
            const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${gid}&single=true&output=csv`;
            
            try {
                const response = await fetch(PROXY + encodeURIComponent(url));
                const csv = await response.text();
                
                const lines = csv.split('\n').filter(line => line.trim());
                if (lines.length === 0) return [];
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                return lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i] || '';
                    });
                    return obj;
                });
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ gid ${gid}:`, error);
                return [];
            }
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        async function initApp() {
            try {
                const [categories, products, cities, checkboxes, config] = await Promise.all([
                    fetchSheet(GIDS.categories),
                    fetchSheet(GIDS.products),
                    fetchSheet(GIDS.cities),
                    fetchSheet(GIDS.checkboxes),
                    fetchSheet(GIDS.appConfig)
                ]);

                appState.categories = categories;
                appState.products = products;
                appState.cities = cities.filter(c => String(c.is_active).toUpperCase() === 'TRUE');
                appState.checkboxes = checkboxes;
                
                appState.config = config.reduce((acc, item) => {
                    acc[item.key] = item.value;
                    return acc;
                }, {});
                
                appState.activeCity = appState.config.default_city || (appState.cities[0]?.city_name) || '–ú–æ—Å–∫–≤–∞';

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                const savedCart = localStorage.getItem('food_cart');
                if (savedCart) {
                    appState.cart = JSON.parse(savedCart);
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerData();

                if (appState.categories.length > 0) {
                    appState.activeCategory = appState.categories[0].id;
                }

                renderEverything();

            } catch (error) {
                console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
                document.getElementById('productsContainer').innerHTML = 
                    '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏<br><span style="font-size:14px;">–ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</span></div>';
            }
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ö–õ–ò–ï–ù–¢–ê ==========
        function loadCustomerData() {
            const savedData = localStorage.getItem('customer_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('customerName').value = data.name || '';
                document.getElementById('customerPhone').value = data.phone || '';
                document.getElementById('customerAddress').value = data.address || '';
                document.getElementById('saveCustomerData').checked = true;
            }
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –ö–õ–ò–ï–ù–¢–ê ==========
        function saveCustomerData() {
            const saveChecked = document.getElementById('saveCustomerData').checked;
            
            if (saveChecked) {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value
                };
                localStorage.setItem('customer_data', JSON.stringify(customerData));
            }
        }

        // ========== –ü–†–û–í–ï–†–ö–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –§–û–†–ú–´ ==========
        function isCustomerFormValid() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return false;
            }
            if (!phone) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return false;
            }
            if (!address) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
                return false;
            }
            return true;
        }

        // ========== –ü–†–û–í–ï–†–ö–ê –ß–ï–ö–ë–û–ö–°–û–í ==========
        function areCheckboxesValid() {
            const requiredCheckboxes = document.querySelectorAll('.checkbox-item input[required]');
            for (let cb of requiredCheckboxes) {
                if (!cb.checked) return false;
            }
            return true;
        }

        // ========== –ü–û–õ–ù–´–ô –†–ï–ù–î–ï–† ==========
        function renderEverything() {
            renderCities();
            renderCategories();
            renderProducts();
            renderCheckboxes();
            updateHeader();
            updateCartUI();
        }

        // ========== –ì–û–†–û–î–ê ==========
        function renderCities() {
            const container = document.getElementById('citiesContainer');
            if (!appState.cities.length) return;
            
            container.innerHTML = appState.cities.map(city => `
                <button class="city-btn ${appState.activeCity === city.city_name ? 'active' : ''}" 
                        onclick="window.selectCity('${city.city_name}')">
                    ${city.city_name}
                </button>
            `).join('');
        }

        // ========== –ö–ê–¢–ï–ì–û–†–ò–ò ==========
        function renderCategories() {
            const nav = document.getElementById('categoriesNav');
            nav.innerHTML = appState.categories.map(cat => `
                <button class="category-tab ${appState.activeCategory == cat.id ? 'active' : ''}"
                        style="${appState.activeCategory == cat.id ? `background: ${cat.btn_color} !important;` : ''}"
                        onclick="window.selectCategory(${cat.id})">
                    ${cat.name}
                </button>
            `).join('');
        }

        // ========== –¢–û–í–ê–†–´ ==========
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const filtered = appState.products.filter(p => String(p.category_id) === String(appState.activeCategory));
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">üçΩÔ∏è –¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>';
                return;
            }

            container.innerHTML = filtered.map(product => {
                const inCart = appState.cart.find(item => String(item.id) === String(product.id));
                return `
                <div class="product-card">
                    <img src="${product.image_url}" class="product-image" alt="${product.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=Food'">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-weight">${product.weight}</div>
                        <div class="product-description">${product.description}</div>
                        <div class="product-bottom">
                            <span class="product-price">${Number(product.price).toLocaleString()} ‚ÇΩ</span>
                            <button class="add-btn" 
                                    onclick="window.addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price})"
                                    style="background: ${getActiveCategoryColor()}">
                                ${inCart ? inCart.quantity : '+'}
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // ========== –ß–ï–ö–ë–û–ö–°–´ ==========
        function renderCheckboxes() {
            const container = document.getElementById('checkboxesContainer');
            if (!appState.checkboxes.length) return;
            
            container.innerHTML = appState.checkboxes.map((box, i) => `
                <label class="checkbox-item">
                    <input type="checkbox" id="cb_${i}" ${String(box.is_required).toUpperCase() === 'TRUE' ? 'required' : ''}>
                    <span>${box.text}</span>
                </label>
            `).join('');
        }

        // ========== –®–ê–ü–ö–ê ==========
        function updateHeader() {
            const cat = appState.categories.find(c => String(c.id) === String(appState.activeCategory));
            if (!cat) return;

            const header = document.getElementById('header');
            const welcomeText = document.getElementById('welcomeText');
            const title = document.getElementById('welcomeTitle');
            
            if (cat.bg_image_url && cat.bg_image_url !== '#' && cat.bg_image_url !== '') {
                header.style.backgroundImage = `url(${cat.bg_image_url})`;
                header.style.backgroundColor = 'transparent';
            } else {
                header.style.backgroundImage = 'none';
                header.style.backgroundColor = cat.bg_color || '#1a1a2e';
            }
            
            welcomeText.textContent = cat.welcome_text || '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!';
            title.textContent = appState.config.app_title || 'Fresh Food Market';
        }

        // ========== –¶–í–ï–¢ –ê–ö–¢–ò–í–ù–û–ô –ö–ê–¢–ï–ì–û–†–ò–ò ==========
        function getActiveCategoryColor() {
            const cat = appState.categories.find(c => String(c.id) === String(appState.activeCategory));
            return cat ? cat.btn_color : '#e94560';
        }

        // ========== –ö–û–†–ó–ò–ù–ê ==========
        window.addToCart = function(id, name, price) {
            const existing = appState.cart.find(item => String(item.id) === String(id));
            if (existing) {
                existing.quantity += 1;
            } else {
                appState.cart.push({ id, name, price, quantity: 1 });
            }
            saveCart();
            renderProducts();
            updateCartUI();
        };

        function saveCart() {
            localStorage.setItem('food_cart', JSON.stringify(appState.cart));
        }

        function updateCartUI() {
            const count = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
            const total = appState.cart.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
            
            document.getElementById('cartCountText').innerHTML = `–ö–æ—Ä–∑–∏–Ω–∞ ¬∑ ${count} ${getWord(count, '—Ç–æ–≤–∞—Ä', '—Ç–æ–≤–∞—Ä–∞', '—Ç–æ–≤–∞—Ä–æ–≤')}`;
            document.getElementById('cartTotalFixed').textContent = total.toLocaleString() + ' ‚ÇΩ';
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã
            const paymentBtn = document.getElementById('paymentBtn');
            if (paymentBtn) {
                paymentBtn.disabled = count === 0;
            }
        }

        function getWord(number, one, few, many) {
            if (number % 10 === 1 && number % 100 !== 11) return one;
            if ([2,3,4].includes(number % 10) && ![12,13,14].includes(number % 100)) return few;
            return many;
        }

        // ========== –í–´–ë–û–† –ì–û–†–û–î–ê ==========
        window.selectCity = function(cityName) {
            appState.activeCity = cityName;
            renderCities();
        };

        // ========== –í–´–ë–û–† –ö–ê–¢–ï–ì–û–†–ò–ò ==========
        window.selectCategory = function(categoryId) {
            appState.activeCategory = categoryId;
            renderCategories();
            renderProducts();
            updateHeader();
        };

        // ========== –ò–ú–ò–¢–ê–¶–ò–Ø –û–ü–õ–ê–¢–´ ==========
        document.getElementById('paymentBtn').addEventListener('click', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
            if (appState.cart.length === 0) {
                alert('üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É
            if (!isCustomerFormValid()) {
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            saveCustomerData();
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã
            this.innerHTML = 'üí≥ –û–ø–ª–∞—á–µ–Ω–æ';
            this.style.background = '#8bc34a';
            this.disabled = true;
            
            appState.isPaid = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫–∞–∑–∞
            document.getElementById('orderBtn').style.display = 'block';
            
            alert('‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑"');
        });

        // ========== –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ==========
        document.getElementById('orderBtn').addEventListener('click', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É
            if (!appState.isPaid) {
                alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –æ–ø–ª–∞—Ç–∏—Ç–µ –∑–∞–∫–∞–∑');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
            if (!areCheckboxesValid()) {
                alert('‚ö†Ô∏è –ü—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
            if (appState.cart.length === 0) {
                alert('üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É
            if (!isCustomerFormValid()) {
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            saveCustomerData();
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–∫–∞–∑
            const total = appState.cart.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
            
            const orderData = {
                action: 'new_order',
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                customerAddress: document.getElementById('customerAddress').value,
                comment: document.getElementById('customerComment').value,
                city: appState.activeCity,
                total: total,
                cart: appState.cart
            };
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google Apps Script
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram Mini App
                if (tg) {
                    tg.sendData(JSON.stringify(orderData));
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                alert(`‚úÖ –ó–ê–ö–ê–ó –û–§–û–†–ú–õ–ï–ù!\n\n–°–ø–∞—Å–∏–±–æ, ${orderData.customerName}!\n–í–∞—à –∑–∞–∫–∞–∑ –Ω–∞ ${total.toLocaleString()} ‚ÇΩ –ø—Ä–∏–Ω—è—Ç.\n–î–æ—Å—Ç–∞–≤–∫–∞: ${orderData.customerAddress}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${orderData.customerPhone}\n\n–°–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –∫—É—Ä—å–µ—Ä.`);
                
                // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                appState.cart = [];
                appState.isPaid = false;
                saveCart();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                const paymentBtn = document.getElementById('paymentBtn');
                paymentBtn.innerHTML = 'üí≥ –ò–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã';
                paymentBtn.style.background = '#00a86b';
                paymentBtn.disabled = false;
                
                document.getElementById('orderBtn').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateCartUI();
                renderProducts();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        });

        // –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        initApp();
    </script>
</body>
</html>